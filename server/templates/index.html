<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ovládanie a Meranie DHT11</title>
  <style>
    body {
      background: #f5f7fa;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      margin: 0;
    }
    h1 { color: #2c3e50; margin-bottom: 1rem; }
    .grid {
      display: grid;
      grid-template: repeat(3, 100px) / repeat(3, 100px);
      gap: 1rem; margin-bottom: 2rem;
    }
    button {
      font-size: 1.2rem; border: none;
      background: #3498db; color: #fff;
      border-radius: .5rem; cursor: pointer;
      padding: .5rem; user-select: none;
    }
    button:active { background: #1c598a; }
    .invisible { visibility: hidden; }
    .meas-btns { display: flex; gap: 1rem; margin-bottom: 1rem; }
    #sensor {
      background: #fff; border: 1px solid #ccc;
      border-radius: 8px; padding: 1rem;
      width: 600px; text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }
    #sensor h2 { margin: 0 0 .5rem; font-size: 1.2rem; }
    #log {
      width: 600px; height: 100px;
      background: #fff; border: 1px solid #ccc;
      padding: .5rem; font-family: monospace;
      overflow-y: auto; box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    .plot {
      width: 600px; height: 300px;
      background: #fff; border: 1px solid #ccc;
      border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }
    .chart-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 2rem;
      margin-bottom: 2rem;
    }
    canvas {
      display: block;
      margin: auto;
    }
  </style>
</head>
<body>
  <h1>Autíčko a meranie s DHT11</h1>

  <div class="grid">
    <div class="invisible"></div>
    <button id="btn-FORWARD">↑</button>
    <div class="invisible"></div>
    <button id="btn-LEFT">←</button>
    <button id="btn-STOP">■</button>
    <button id="btn-RIGHT">→</button>
    <div class="invisible"></div>
    <button id="btn-BACKWARD">↓</button>
    <div class="invisible"></div>
  </div>

  <div class="meas-btns">
    <button id="btn-START">Začať meranie</button>
    <button id="btn-EXIT" style="display:none;">Ukončiť meranie</button>
  </div>

  <div id="sensor">
    <h2>Senzor DHT11</h2>
    <p>Teplota: <span id="temp">--</span> °C</p>
    <p>Vlhkosť: <span id="hum">--</span> %</p>
  </div>

  <div id="log"></div>

  <div class="chart-container">
    <div>
      <div id="plotTemp" class="plot"></div>
      <canvas id="gaugeTemp" width="250" height="250"></canvas>
      <div id="gaugeTemp-value" style="text-align:center; font-weight:bold;">-- °C</div>
    </div>
    <div>
      <div id="plotHum" class="plot"></div>
      <canvas id="gaugeHum" width="250" height="250"></canvas>
      <div id="gaugeHum-value" style="text-align:center; font-weight:bold;">-- %</div>
    </div>
  </div>

  <!-- JS knižnice -->
  <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
  <script src="/static/libs/gauge.min.js"></script>

  <script>
    const cmdSocket = io();
    function sendCmd(dir) {
      cmdSocket.emit('command', { direction: dir });
    }
    ['FORWARD','BACKWARD','LEFT','RIGHT'].forEach(dir => {
      const b = document.getElementById('btn-'+dir);
      b.addEventListener('mousedown',  ()=>sendCmd(dir));
      b.addEventListener('mouseup',    ()=>sendCmd('STOP'));
      b.addEventListener('touchstart', e=>{ e.preventDefault(); sendCmd(dir); });
      b.addEventListener('touchend',   e=>{ e.preventDefault(); sendCmd('STOP'); });
    });
    document.getElementById('btn-STOP')
            .addEventListener('click', ()=>sendCmd('STOP'));

    const dhtSocket = io('/dht');
    const btnStart = document.getElementById('btn-START');
    const btnExit  = document.getElementById('btn-EXIT');
    const logEl    = document.getElementById('log');

    btnStart.addEventListener('click', () => {
      console.log('Začať meranie - klik!');
      dhtSocket.emit('toggle_running');
    });

    btnExit .addEventListener('click', ()=> dhtSocket.emit('toggle_running'));

    dhtSocket.on('connect', ()=>console.log('DHT connected'));
    dhtSocket.on('disconnect', ()=>console.log('DHT disconnected'));

    const maxPoints = 10;
    let tempX = [], tempY = [], humX = [], humY = [];

    Plotly.newPlot('plotTemp', [{ x:[], y:[], mode:'lines+markers', name:'Teplota (°C)' }],
      { title:'Teplota v čase', xaxis:{title:'Čas', tickangle:-45}, yaxis:{title:'°C'} });

    Plotly.newPlot('plotHum', [{ x:[], y:[], mode:'lines+markers', name:'Vlhkosť (%)' }],
      { title:'Vlhkosť v čase', xaxis:{title:'Čas', tickangle:-45}, yaxis:{title:'%'} });

    // RadialGauge - Teplota
    let gaugeTemp = new RadialGauge({
      renderTo: document.getElementById("gaugeTemp"),
      width: 250,
      height: 250,
      units: "°C",
      minValue: 0,
      maxValue: 50,
      majorTicks: [0, 10, 20, 30, 40, 50],
      minorTicks: 2,
      strokeTicks: true,
      highlights: [
        { from: 0, to: 25, color: "#30B32D" },
        { from: 25, to: 35, color: "#FFDD00" },
        { from: 35, to: 50, color: "#F03E3E" }
      ],
      colorPlate: "#fff",
      needleType: "arrow",
      valueBox: true,
      valueInt: 2,
      valueDec: 1,
      animation: true,
      animationDuration: 300,
      animatedValue: true
    }).draw();

    // RadialGauge - Vlhkosť
    let gaugeHum = new RadialGauge({
      renderTo: document.getElementById("gaugeHum"),
      width: 250,
      height: 250,
      units: "%",
      minValue: 0,
      maxValue: 100,
      majorTicks: [0, 20, 40, 60, 80, 100],
      minorTicks: 2,
      strokeTicks: true,
      highlights: [
        { from: 30, to: 60, color: "#30B32D" },
        { from: 60, to: 80, color: "#FFDD00" },
        { from: 80, to: 100, color: "#F03E3E" }
      ],
      colorPlate: "#fff",
      needleType: "arrow",
      valueBox: true,
      valueInt: 2,
      valueDec: 1,
      animation: true,
      animationDuration: 300,
      animatedValue: true
    }).draw();

    dhtSocket.on('dht_status', msg => {
      btnStart.style.display = msg.running ? 'none' : '';
      btnExit.style.display  = msg.running ? ''   : 'none';
    });

    dhtSocket.on('dht_data', msg => {
      const tm = new Date(msg.timestamp * 1000).toLocaleTimeString();
      tempX.push(tm); tempY.push(msg.temperature);
      humX.push(tm);  humY.push(msg.humidity);

      if (tempX.length > maxPoints) {
        tempX.shift(); tempY.shift();
        humX.shift();  humY.shift();
      }

      Plotly.update('plotTemp', { x: [tempX], y: [tempY] });
      Plotly.update('plotHum',  { x: [humX],  y: [humY] });

      document.getElementById('temp').textContent = msg.temperature.toFixed(1);
      document.getElementById('hum').textContent  = msg.humidity.toFixed(1);
      document.getElementById('gaugeTemp-value').textContent = `${msg.temperature.toFixed(1)} °C`;
      document.getElementById('gaugeHum-value').textContent  = `${msg.humidity.toFixed(1)} %`;

      const line = `${tm} → T:${msg.temperature.toFixed(1)}°C H:${msg.humidity.toFixed(1)}%`;
      logEl.innerHTML += line + '<br>';
      logEl.scrollTop = logEl.scrollHeight;

      gaugeTemp.value = msg.temperature;
      gaugeHum.value  = msg.humidity;
    });
  </script>
</body>
</html>
